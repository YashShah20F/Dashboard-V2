import React, { useState } from 'react';
import {
  Camera,
  Shapes,
  Text,
  Palette,
  Ruler,
  ImagePlus,
  Loader2,
  AlertCircle
} from 'lucide-react';

// Use this for local development if needed, it will be automatically populated in the canvas environment.
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Define the API URL for the model
const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent';

// Box component for displaying different analysis results
const Box = ({ title, content, icon: IconComponent }) => (
  <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
    <div className="flex items-center mb-4">
      {IconComponent && <IconComponent className="text-blue-500 mr-3 w-6 h-6" />}
      <h3 className="text-xl font-semibold text-gray-800">{title}</h3>
    </div>
    <div className="text-gray-600 space-y-2">
      {content.length > 0 ? (
        <ul className="list-disc list-inside space-y-1">
          {content.map((item, index) => (
            <li key={index} className="text-gray-700">{item}</li>
          ))}
        </ul>
      ) : (
        <p className="text-gray-500 italic">No information available.</p>
      )}
    </div>
  </div>
);

// Main App component
const App = () => {
  const [image, setImage] = useState(null);
  const [analysis, setAnalysis] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // Handle file input changes
  const handleImageChange = (e) => {
    if (e.target.files && e.target.files[0]) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onloadend = () => {
        setImage(reader.result.split(',')[1]); // Store base64 data without the prefix
        setAnalysis(null);
        setError(null);
      };
      reader.readAsDataURL(file);
    }
  };

  // Function to make API call with exponential backoff
  const makeApiCall = async (prompt, retries = 3, delay = 1000) => {
    let lastError = null;
    for (let i = 0; i < retries; i++) {
      try {
        const payload = {
          contents: [
            {
              role: 'user',
              parts: [
                { text: prompt },
                {
                  inlineData: {
                    mimeType: 'image/png',
                    data: image,
                  },
                },
              ],
            },
          ],
        };

        const apiKey = ''; // Will be populated by the canvas environment
        const response = await fetch(`${API_URL}?key=${apiKey}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`API call failed with status: ${response.status}`);
        }

        const result = await response.json();
        if (result.candidates && result.candidates.length > 0 && result.candidates[0].content) {
          return result.candidates[0].content.parts[0].text;
        } else {
          throw new Error('No candidate found in the API response.');
        }
      } catch (e) {
        lastError = e;
        if (i < retries - 1) {
          await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
        }
      }
    }
    throw lastError;
  };

  // Function to analyze the image
  const analyzeImage = async () => {
    if (!image) {
      setError("Please upload an image first.");
      return;
    }

    setLoading(true);
    setError(null);

    try {
      // Use the LLM to analyze various aspects of the image
      const analysisPrompt =
        'Based on the provided image, provide a detailed analysis on the following aspects, presented as a list. If you cannot find information for a category, state "No information available.". ' +
        '1. **Object and Scene Recognition**: List the primary objects and the overall scene or setting (e.g., "A dog sitting in a park"). ' +
        '2. **Color Palette and Aesthetics**: Describe the main colors, overall mood, and aesthetic style (e.g., "Muted tones, warm and cozy atmosphere"). ' +
        '3. **Text and Labels**: Identify any visible text or labels (e.g., "Text on a sign says: \'Welcome\'"). ' +
        '4. **Dimensions and Composition**: Describe the image\'s composition, perspective, and any notable spatial relationships (e.g., "Subject is in the center, close-up shot"). ' +
        '5. **Image Quality and Details**: Comment on the quality, lighting, and any fine details (e.g., "Sharp focus, bright natural light, slight blur in the background"). ';

      const rawAnalysis = await makeApiCall(analysisPrompt);

      // Parse the raw analysis text into a structured format
      const parsedAnalysis = parseAnalysis(rawAnalysis);
      setAnalysis(parsedAnalysis);

    } catch (e) {
      console.error("Error during image analysis:", e);
      setError("Failed to analyze the image. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  // Helper function to parse the raw text response into a structured object
  const parseAnalysis = (text) => {
    const sections = text.split(/\d+\. \*\*(.*?)\*\*: /).slice(1);
    const analysisObject = {};
    for (let i = 0; i < sections.length; i += 2) {
      const title = sections[i];
      const content = sections[i + 1].split('\n').filter(line => line.trim().length > 0);
      analysisObject[title.replace(/\s/g, '_').toLowerCase()] = content;
    }
    return analysisObject;
  };

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-800 p-8 flex items-center justify-center">
      <div className="max-w-4xl w-full bg-gray-100 rounded-3xl shadow-2xl p-8 lg:p-12">
        <header className="text-center mb-8">
          <h1 className="text-4xl lg:text-5xl font-extrabold text-gray-900 mb-2">Image Insight</h1>
          <p className="text-lg text-gray-600">Upload an image to get a detailed analysis.</p>
        </header>

        <div className="flex flex-col items-center mb-8">
          <div className="w-full max-w-sm h-64 border-4 border-dashed border-gray-300 rounded-2xl flex items-center justify-center relative bg-gray-200 overflow-hidden">
            {image ? (
              <img src={`data:image/png;base64,${image}`} alt="Uploaded" className="object-contain w-full h-full" />
            ) : (
              <div className="text-center text-gray-500 p-4">
                <ImagePlus className="w-16 h-16 mx-auto mb-3" />
                <p className="font-medium">Drag & drop or click to upload</p>
              </div>
            )}
            <input
              type="file"
              accept="image/*"
              className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
              onChange={handleImageChange}
            />
          </div>
          <button
            onClick={analyzeImage}
            disabled={loading || !image}
            className={`mt-6 px-8 py-3 rounded-full text-white font-bold text-lg shadow-lg transform transition-all duration-300
              ${image ? 'bg-blue-600 hover:bg-blue-700 hover:scale-105' : 'bg-gray-400 cursor-not-allowed'}
              flex items-center justify-center`}
          >
            {loading ? (
              <>
                <Loader2 className="animate-spin mr-3" />
                Analyzing...
              </>
            ) : (
              'Analyze Image'
            )}
          </button>
        </div>

        {error && (
          <div className="mb-8 p-4 bg-red-100 text-red-700 rounded-xl flex items-center shadow-md">
            <AlertCircle className="w-6 h-6 mr-3" />
            <span className="font-medium">{error}</span>
          </div>
        )}

        {analysis && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
            <Box
              title="Object and Scene Recognition"
              content={analysis.object_and_scene_recognition}
              icon={Camera}
            />
            <Box
              title="Color Palette and Aesthetics"
              content={analysis.color_palette_and_aesthetics}
              icon={Palette}
            />
            <Box
              title="Text and Labels"
              content={analysis.text_and_labels}
              icon={Text}
            />
            <Box
              title="Dimensions and Composition"
              content={analysis.dimensions_and_composition}
              icon={Ruler}
            />
            <Box
              title="Image Quality and Details"
              content={analysis.image_quality_and_details}
              icon={Shapes}
            />
          </div>
        )}
      </div>
    </div>
  );
};

export default App;

